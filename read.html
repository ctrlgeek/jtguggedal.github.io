
<!doctype html>
<!--
Copyright 2016 Google Inc. All Rights Reserved.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<html lang="en">
  <head>


        <style>
            .notification {
                display: inline-block;
                margin: 20px;
                width: 20px;
                width: 20px;
                background-color: red;
            }

            h2 {
                display: inline-block;
                clear: both;
                cursor: pointer;
                padding: 7px;
                background-color: #eee;
                margin: 20px;
            }
        </style>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Sample illustrating the use of Web Bluetooth / Battery Level.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Physical Web</title>
    
    
  </head>

  <body>
    <h1>Web Bluetooth: read, write & notify</h1>
<button>Koble til</button>

<script>
  var ChromeSamples = {
    log: function() {
      var line = Array.prototype.slice.call(arguments).map(function(argument) {
        return typeof argument === 'string' ? argument : JSON.stringify(argument);
      }).join(' ');

      document.querySelector('#log').textContent += line + '\n';
    },

    clearLog: function() {
      document.querySelector('#log').textContent = '';
    },

    setStatus: function(status) {
      document.querySelector('#status').textContent = status;
    },

    setContent: function(newContent) {
      var content = document.querySelector('#content');
      while(content.hasChildNodes()) {
        content.removeChild(content.lastChild);
      }
      content.appendChild(newContent);
    }
  };
</script>
<h2  onclick="readFromCharacteristic(1)">Les</h2>
<h2 onclick="writeToCharacteristic(1, 240)">Skriv</h2>




<div>
    <div class="notification" id="notification_1">&nbsp;</div>
    <div class="notification" id="notification_2">&nbsp;</div>
    <div class="notification" id="notification_3">&nbsp;</div>
    <div class="notification" id="notification_4">&nbsp;</div>
</div>
<h3>Logg</h3>
<div id="output" class="output">
  <div id="content"></div>
  <div id="status"></div>
  <pre id="log"></pre>
</div>



  
    
<script>

    /** Declaring the necessary global variables **/
    var mainServiceUUID = '00001523-1212-efde-1523-785feabcd123';
    var readWriteCharacteristicUUID = '00001525-1212-efde-1523-785feabcd123';
    var notificationCharacteristicUUID = '00001524-1212-efde-1523-785feabcd123';

    var mainService;
    var readWriteCharacteristic;
    var notificationCharacteristic;

    var notificationContent;

    /** Function for establishing BLE connection to device advertising the main service **/
    function onButtonClick() {
        'use strict';

        log('Requesting Bluetooth Device...');
        navigator.bluetooth.requestDevice(
            {filters: [{services: [mainServiceUUID]}]})
            .then(device => {
                log('> Found ' + device.name);
                log('Connecting to GATT Server...');
                return device.connectGATT();
            })
            .then(server => {
                log('Getting main Service...');
                return server.getPrimaryService(mainServiceUUID);
            })
            .then(service => {
                mainService = service;
                return Promise.all([
                    service.getCharacteristic(readWriteCharacteristicUUID)
                    .then(readWriteCharacteristicHandler),
                    service.getCharacteristic(notificationCharacteristicUUID)
                    .then(notificationCharacteristicHandler)
                ])
                .catch(error => {
                    log('>' + error);
                });
            })
        .catch(error => {
            log('Argh! ' + error);
        });
    }

    /** Function for setting up the notification characteristic **/
    function notificationCharacteristicHandler(characteristic) {
        'use strict';
        notificationCharacteristic = characteristic;
        log('Notifications started.')
        notificationCharacteristic.addEventListener('characteristicvaluechanged',handleNotification);
        return characteristic.startNotifications();
    }

     /** Function for handling the read and write characteristic **/
    function readWriteCharacteristicHandler(characteristic) {
        'use strict';
        readWriteCharacteristic = characteristic;
        return 1;
    }


    /** Function for handling notifications **/
    function handleNotification(event) {
        'use strict';
        let value = event.target.value;
        value = value.buffer ? value : new DataView(value);

        // Testing, testing...
                var bg_1, 
                    bg_2, 
                    bg_3, 
                    bg_4;

                if(value.getUint8(0) == 1)
                    bg_1 = 'blue';
                else
                    bg_1 = 'red';
                if(value.getUint8(1) == 1)
                    bg_2 = 'blue';
                else
                    bg_2 = 'red';
                if(value.getUint8(2) == 1)
                    bg_3 = 'blue';
                else
                    bg_3 = 'red';
                if(value.getUint8(3) == 1)
                    bg_4 = 'blue';
                else
                    bg_4 = 'red';

                document.getElementById("notification_1").style.backgroundColor = bg_1;
                document.getElementById("notification_2").style.backgroundColor = bg_2;
                document.getElementById("notification_3").style.backgroundColor = bg_3;
                document.getElementById("notification_4").style.backgroundColor = bg_4;

                console.log(value);
         //**** Testing end

        return value;

    }


    /** Function for reading from the pin_handler_characteristic **/
    function readFromCharacteristic(byteOffset) {
        'use strict';
        var data;
        readWriteCharacteristic.readValue()
          .then(value => {
            value = value.buffer ? value : new DataView(value);
            if(byteOffset == 'all') {
                data = new Uint8Array(20);
                for(var i = 0; i < 20 ; i++) {
                    data[i] = value.getUint8(i);
                }
            } else {
                data = value.getUint8(byteOffset);
            }
        });
        return data;
    }

    /** Function for writing to the pin_handler_characeristic **/
    function writeToCharacteristic(byteOffset, value) {
        'use strict';
        var charVal = readFromCharacteristic('all');
        charVal[byteOffset] = value;
        readWriteCharacteristic.writeValue(charVal);
        if(readFromCharacteristic(byteOffset) == value)
            return 1;
        else
            return 0;
    }

</script>



<script>
  document.querySelector('button').addEventListener('click', function() {
    if (!navigator.bluetooth) {
      ChromeSamples.setStatus('Web Bluetooth API is not available.\n' +
        'Please make sure the Web Bluetooth flag is enabled.');
    } else {
      ChromeSamples.clearLog();
      onButtonClick();
    }
  });
  log = ChromeSamples.log;
</script>

  </body>
</html>