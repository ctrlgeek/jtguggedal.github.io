
<!doctype html>
<html lang="en">
  <head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0-beta1/jquery.js"></script>   
    <script src="js/gatt.js"></script>    
    <script src="js/setBit.js"></script>
    <script src="js/pep.js"></script>   


    <style>
        @import url(https://fonts.googleapis.com/css?family=Open+Sans|Roboto:400,500,700,300);
        body {
            font-family: "Roboto";
            margin: 0;
            padding: 20px;
        }
        .notification {
            display: inline-block;
            margin: 15px;
            width: 35px;
            height: 35px;
            background-color: blue;
            color: white;
            font-size: 34px;
            text-align: center;
            font-weight: 700;
        }

        h2 {
            display: inline-block;
            clear: both;
            cursor: pointer;
            padding: 7px;
            background-color: #eee;
            margin: 10px;
        }

        .demo {
            background: #f3eee6;
            width: 200px;
            height: 200px;
            display: inline-block;
            border-radius: 100px;
            margin: 0;
        }


        .ball {
            width: 70px;
            height: 70px;
            background: red;
            position: absolute;
            top: 65px;
            left: 65px;
            border-radius: 70px;
        }
        .ball.outline {
          background: #eee;
        }
        .ball.ease {
          -moz-transition: all 0.2s ease;
          -o-transition: all 0.2s ease;
          -webkit-transition: all 0.2s ease;
          transition: all 0.2s ease;
        }

        #pos-x, #pos-y {
            margin-left: 20px;

        }

    </style>

    <title>Physical Web</title>
    
</head>

    <body>
        <h1>Web Bluetooth: read, write & notify</h1>

     
        <h2 onclick="connect();" id='connect'>Koble til</h2>
        <h2 onclick="readFromCharacteristic(1);">Les</h2>
        <h2 onclick="writeToCharacteristic(1, 240);">Skriv</h2>




        <div>
            <div class="notification" id="notification_1">1</div>
            <div class="notification" id="notification_2">2</div>
            <div class="notification" id="notification_3">3</div>
            <div class="notification" id="notification_4">4</div>
        </div>


        <div class='demo constrain-to-parent'>
          <div class='ball outline'></div>
          <div class='ball moveable'></div>
        </div>
                <p id="pos-x"></p>
                <p id="pos-y"></p>


        <h3>Logg</h3>
        <div id="output" class="output">
          <div id="content"></div>
          <div id="status"></div>
          <pre id="log"></pre>
        </div>




        <script>
          var ChromeSamples = {
            log: function() {
              var line = Array.prototype.slice.call(arguments).map(function(argument) {
                return typeof argument === 'string' ? argument : JSON.stringify(argument);
              }).join(' ');

              document.querySelector('#log').textContent += line + '\n';
            },

            clearLog: function() {
              document.querySelector('#log').textContent = '';
            },

            setStatus: function(status) {
              document.querySelector('#status').textContent = status;
            },

            setContent: function(newContent) {
              var content = document.querySelector('#content');
              while(content.hasChildNodes()) {
                content.removeChild(content.lastChild);
              }
              content.appendChild(newContent);
            }
          };
        </script>

        <script>
          document.querySelector('#connect').addEventListener('click', function() {
            if (!navigator.bluetooth) {
              ChromeSamples.setStatus('Web Bluetooth API is not available.\n' +
                'Please make sure the Web Bluetooth flag is enabled.');
            } else {
              ChromeSamples.clearLog();
            }
          });
          log = ChromeSamples.log;
        </script>


        <script>
        
            $('.ball').on("mousemove touchmove", function() {

                // Lagrer n책-verdien fra slideren i variabelen 'sliderVal' (med jQuery-selector)

                var offset = $ball.position();
                var offsetY = initialOffset.top - offset.top;
                var offsetX = -1*(initialOffset.left - offset.left);
                var charVal = new Uint8Array(20);

                // Sjekker at tilkobling ble opprettet tidligere
                if(readWriteCharacteristic) {

                    // Sjekker i hvilket intervall slider-verdien er, og sender korresponderende verdi
                    // via BLE til firmware. 
                    // Setter 1. bit lik 1 for 책 tenne 1. LED osv.


                    if(offsetX < 0 && offsetY < 0)
                        setBit(1, 0, 1);        // 0001
                    else 
                        setBit(1, 0, 0);
                    if(offsetX < 0 && offsetY > 0)      
                        setBit(1, 1, 1);        // 0010
                    else
                        setBit(1, 1, 0);
                    if(offsetX > 0 && offsetY > 0)
                        setBit(1, 2, 1);        // 0100
                    else
                        setBit(1, 2, 0);
                    if(offsetX > 0 && offsetY < 0)
                        setBit(1, 3, 1);        // 1000
                    else
                        setBit(1, 3, 0)

                    console.log(charVal);

                    if((offsetX == 0) && (offsetY == 0))
                        setBit(1, 'b', 0);

                    console.log(charVal);


                    return readWriteCharacteristic.writeValue(charVal);
                }
            });


            // Funksjon for at joysticken skal g책 tilbake til nullpunktet n책r den slippes
            var REVERT_THRESHOLD = 1000;
            var $ball = $('.ball.moveable');
            var initialOffset = $ball.offset();


            $('.ball').on("change mousemove touchmove", function() {
                  var offset = $ball.position();
                  var offsetY = initialOffset.top - offset.top;
                  var offsetX = -1*(initialOffset.left - offset.left)
      
                 $('#pos-x').html('x: ' + offsetX + 'px');
                 $('#pos-y').html('y: ' + offsetY + 'px');
            });

            $ball.pep({
  
              useCSSTranslation: false,
              shouldEase: false,
              constrainTo: 'parent',
               initiate: function(){
                 this.$el.removeClass('ease')
               },
              stop: function(){
                var offset = this.$el.position();    
                var diffTop  = initialOffset.top - offset.top;
                var diffLeft = -1*(initialOffset.left - offset.left);

                if ( diffTop < REVERT_THRESHOLD && diffLeft < REVERT_THRESHOLD ){
                  this.$el.css( initialOffset ).addClass('ease') ;


                resetJoystickPosition();
                


                }
              }
            })

            function resetJoystickPosition() {
      
                $('#pos-x').html('x: 0px');
                $('#pos-y').html('y: 0px');

                if(writeToCharacteristic(1, 0) == 1 ){
                    console.log('Reset successful');
                    return 1;
                } else {
                    console.log('Reset failed.');
                    return 0;
                }

            }
        </script>


    </body>
</html>