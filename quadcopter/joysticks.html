<!doctype html>
<html>
    <head>
        <title>Joystick testing</title>
        <meta charset="utf-8">
        <meta name="description" content="BLE quadcopter controller">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="css/style.css">
        <link rel="stylesheet" type="text/css" href="css/joystick.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
        <script src="js/func.js"></script>
        <script src="js/nipple.js"></script>
    </head>
    <body>
        <div id="connectionStatus">
            Connection status
        </div>
        <div id="joystick-container">
            <div id="joystick-left" class="joystick-wrapper">
            </div>
            <div id="joystick-right" class="joystick-wrapper">
            </div>
        </div>
        <div id="debug-container">
            <div id="debug-containerLeft">
                <p id="debug-throttleLeft">
                    <b>Throttle</b>: 0
                </p>
                <p id="debug-yawLeft">
                    <b>Yaw</b>: 0
                </p>
            </div>
            <div id="debug-containerRight">
                <p id="debug-pitchRight">
                    <b>Pitch</b>: 0
                </p>
                <p id="debug-rollRight">
                    <b>Roll</b>: 0
                </p>
            </div>
        </div>
        <div id="button-settings-pid" class="shadow-1">
            Edit PID
        </div>
        <div id="button-settings" class="shadow-1">
            <img src="img/settings.png">
        </div>
        <div id="settings-overlay">
        </div>
        <!-- Settings menu -->
        <div id="settings-container" class="overlay-container">
            <div id="settings-inner-container">
                <h2 class="heading-menu">Settings</h2>
                <div class="settings-row">
                    <span class="settings-row-label">Maximum roll angle [degrees]</span>
                    <input type="number" id="settings-maxRoll" class="settings-row-value" >
                </div>
                <div class="settings-row">
                    <span class="settings-row-label">Maximum pitch angle [degrees]</span>
                    <input type="number"  id="settings-maxPitch" class="settings-row-value" >
                </div>
                <div class="settings-row">
                    <span class="settings-row-label">Calibrate quadcopter</span>
                    <div id="button-settings-calibrate" class="button-settings" >
                        Do it
                    </div>
                </div>
                <div id="button-settings-container">
                    <div id="button-settings-save" class="button-settings">
                        Save
                    </div>
                    <div id="button-settings-back" class="button-settings button-settings-back">
                        Back
                    </div>
                </div>
            </div>
        </div>
        <!-- END settings menu-->

        <!-- PID settings menu -->
        <div id="settings-container-pid" class="overlay-container">
            <div id="settings-inner-container-pid">
                <div class="button-row">
                    <button type="button" id="button-send">Update</button>
                    <button type="button" id="button-reset">Reset</button>
                    <button type="button" id="button-stop" class="button-settings-back">Back</button>
                </div>
                <!--
                <div class="pid-tuning-group">
                    <fieldset class="pid-tuning-field throttle">
                        <legend>Throttle</legend>
                        <label for="throttle" class="pid-tuning-label">Throttle:</label>
                        <input type="number" id="throttle" class="pid-tuning-input" min="0" max="255" value="0" disabled>
                    </fieldset>
                </div>
                <div class="pid-tuning-group">
                    <fieldset class="pid-tuning-field">
                        <legend>Roll</legend>
                        <label for="roll-right" class="pid-tuning-label">Right:</label>
                        <input type="number" id="roll-right" class="pid-tuning-input" min="0" max="255" disabled>
                        <label for="roll-left" class="pid-tuning-label">Left:</label>
                        <input type="number" id="roll-left" class="pid-tuning-input" min="0" max="255" disabled>
                    </fieldset>
                </div>
                <div class="pid-tuning-group">
                    <fieldset class="pid-tuning-field">
                        <legend>Pitch</legend>
                        <label for="pitch-forward" class="pid-tuning-label">Forward:</label>
                        <input type="number" id="pitch-forward" class="pid-tuning-input" min="0" max="255" disabled>
                        <label for="pitch-backward" class="pid-tuning-label">Backward:</label>
                        <input type="number" id="pitch-backward" class="pid-tuning-input" min="0" max="255" disabled>
                    </fieldset>
                </div>
                <div class="pid-tuning-group">
                    <fieldset class="pid-tuning-field">
                        <legend>Yaw</legend>
                        <label for="yaw-right" class="pid-tuning-label">Right:</label>
                        <input type="number" id="yaw-right" class="pid-tuning-input" min="0" max="255" disabled>
                        <label for="yaw-left" class="pid-tuning-label">Left:</label>
                        <input type="number" id="yaw-left" class="pid-tuning-input" min="0" max="255" disabled>
                    </fieldset>
                </div>
            -->
                <div class="pid-tuning-group">
                    <fieldset class="pid-tuning-field">
                        <legend>Roll - slave</legend>
                        <label for="roll-slave-p" class="pid-tuning-label">P:</label>
                        <input type="number" id="roll-slave-p" class="pid-tuning-input" min="0" max="255" disabled>
                        <label for="roll-slave-i" class="pid-tuning-label">I:</label>
                        <input type="number" id="roll-slave-i" class="pid-tuning-input" min="0" max="255" disabled>
                        <label for="roll-slave-d" class="pid-tuning-label">D:</label>
                        <input type="number" id="roll-slave-d" class="pid-tuning-input" min="0" max="255" disabled>
                    </fieldset>
                </div>
                <div class="pid-tuning-group">
                    <fieldset class="pid-tuning-field">
                        <legend>Roll - master</legend>
                        <label for="roll-master-p" class="pid-tuning-label">P:</label>
                        <input type="number" id="roll-master-p" class="pid-tuning-input" min="0" max="255" disabled>
                        <label for="roll-master-i" class="pid-tuning-label">I:</label>
                        <input type="number" id="roll-master-i" class="pid-tuning-input" min="0" max="255" disabled>
                        <label for="roll-master-d" class="pid-tuning-label">D:</label>
                        <input type="number" id="roll-master-d" class="pid-tuning-input" min="0" max="255" disabled>
                    </fieldset>
                </div>
                <div class="pid-tuning-group">
                    <fieldset class="pid-tuning-field">
                        <legend>Pitch - slave</legend>
                        <label for="pitch-slave-p" class="pid-tuning-label">P:</label>
                        <input type="number"  id="pitch-slave-p" class="pid-tuning-input" min="0" max="255" disabled>
                        <label for="pitch-slave-i" class="pid-tuning-label">I:</label>
                        <input type="number" id="pitch-slave-i" class="pid-tuning-input" min="0" max="255" disabled>
                        <label for="pitch-slave-d" class="pid-tuning-label">D:</label>
                        <input type="number"  id="pitch-slave-d" class="pid-tuning-input" min="0" max="255" disabled>
                    </fieldset>
                </div>
                <div class="pid-tuning-group">
                    <fieldset class="pid-tuning-field">
                        <legend>Pitch - master</legend>
                        <label for="pitch-master-p" class="pid-tuning-label">P:</label>
                        <input type="number" id="pitch-master-p" class="pid-tuning-input" min="0" max="255" disabled>
                        <label for="pitch-master-i" class="pid-tuning-label">I:</label>
                        <input type="number" id="pitch-master-i" class="pid-tuning-input" min="0" max="255" disabled>
                        <label for="pitch-master-d" class="pid-tuning-label">D:</label>
                        <input type="number" id="pitch-master-d" class="pid-tuning-input" min="0" max="255" disabled>
                    </fieldset>
                </div>
                <div class="pid-tuning-group">
                    <fieldset class="pid-tuning-field">
                        <legend>Yaw - slave</legend>
                        <label for="yaw-slave-p" class="pid-tuning-label">P:</label>
                        <input type="number" id="yaw-slave-p" class="pid-tuning-input" min="0" max="255" disabled>
                        <label for="yaw-slave-i" class="pid-tuning-label">I:</label>
                        <input type="number" id="yaw-slave-i" class="pid-tuning-input" min="0" max="255" disabled>
                        <label for="yaw-slave-d" class="pid-tuning-label">D:</label>
                        <input type="number" id="yaw-slave-d" class="pid-tuning-input" min="0" max="255" disabled>
                    </fieldset>
                </div>
                <div class="pid-tuning-group">
                    <fieldset class="pid-tuning-field">
                        <legend>Yaw - master</legend>
                        <label for="yaw-master-p" class="pid-tuning-label">P:</label>
                        <input type="number" id="yaw-master-p" class="pid-tuning-input" min="0" max="255" disabled>
                        <label for="yaw-master-i" class="pid-tuning-label">I:</label>
                        <input type="number" id="yaw-master-i" class="pid-tuning-input" min="0" max="255" disabled>
                        <label for="yaw-master-d" class="pid-tuning-label">D:</label>
                        <input type="number" id="yaw-master-d" class="pid-tuning-input" min="0" max="255" disabled>
                    </fieldset>
                </div>
            </div>
        </div>
        <!-- END PID settings menu -->

        <script>

            /*  Event listeners  */

            // Settings menu
            addListener("#button-settings", "click", function() {
                $("#settings-container").fadeIn(400);
                $("#settings-overlay").fadeIn(400);
                select("#settings-maxRoll").value = maxRoll;
                select("#settings-maxPitch").value = maxPitch;
            });

            addListener('#button-settings-save', 'click', function() {
                maxRoll = select('#settings-maxRoll').value;
                maxPitch = select('#settings-maxPitch').value;
                $("#settings-container").fadeOut(400);
                $("#settings-overlay").fadeOut(400);
            });

            $(".button-settings-back, #settings-overlay, #button-send, .overlay-container").click( function() {
                $("#settings-container, #settings-container-pid").fadeOut(400);
                $("#settings-overlay").fadeOut(400);
            }).children().click(function(e) {
                return false;
            });

            $('#button-settings-calibrate').click( function() {
                exCharVal[10] = calibrateCounter;
                calibrateCounter++;
                var self = $(this);
                writeArrayToChar(exChar, exCharVal)
                .then( () => {
                    self.css({"background-color": "rgb(6, 116, 54)"});
                    self.text('Sent');
                });
            });

            // Edit PID
            addListener("#button-settings-pid", "click", function() {
                $("#settings-container-pid").fadeIn(400, function() {
                    inputPidData();
                });
                $("#settings-overlay").fadeIn(400);
            });


            /*  BLE functions  */

            var originalPidData = new Uint8Array(20);
            var calibrateCounter = 1;

            // Function called when connection is established and all characteristic
            // promises are resolved
            function onConnect() {

                // Read all the original PID values from the quadcopter and
                // store to originalPidData array
                readPidData();
            }

            // Get PID values from quadcopter on connect
            function readPidData() {
                return rxChar.readValue()
                    .then(originalPid => {

                        // Convert from dataView to Uint8Array and save original
                        // PID data for possible future reset
                        originalPidData = new Uint8Array(originalPid.buffer);
                        rxCharVal = originalPidData;
                        console.log("Original PID data received:", originalPidData);

                        // Write original PID data to input boxes
                        for(var i = 1; i <= 18; i++) {
                            select(inputMap[i]).value = originalPidData[i];
                        }
                    });
            }


            //**
            //     Joystick, based on the amazing nippleJS by @yoannmoinet: http://yoannmoinet.github.io/nipplejs/
            //**


            // Settings for joystick
            var printPosition = 1;
            var maxRoll = 20;
            var maxPitch = 20;
            var yawStabilize = true;

            // Define byte indexes for joystick data
            var output =    {
                                throttle : 0,
                                rollRight : 1,
                                rollLeft : 2,
                                pitchForward : 3,
                                pitchBackward : 4,
                                yawRight : 5,
                                yawLeft : 6
                            };


            /** Joystick left  **/
            var joystickLeft = nipplejs.create({
                zone: select('#joystick-left'),
                mode: 'static',
                position: {left: '100px', top: '40%'},
                color: 'rgb(25, 66, 103)',
                size: 150,
                restOpacity: 0.95
            });
            var joystickLeftPos = joystickLeft.position;
            var joystickSize = joystickLeft.options.size;
            var joystickCenter = joystickSize / 2;

            // Function for positioning the left joystick correctly when released
            function reapplyLeft(el) {
                select(el).style.top = "75px";
            }

            // Apply style to joysticks on load
            (function() {
                setTimeout(function() {
                    reapplyJoystick();
                }, 1500);
            })();

            function reapplyJoystick() {

                // Set gradient for front on left joystick
                var front_l = select(".collection_0 .front").style;
                var front_r = select(".collection_1 .front").style;
                var back_l = select(".collection_0 .back");

                front_l.background = "radial-gradient(ellipse at center,  rgba(51, 110, 163, 1) 0%, rgba(25, 66, 103, 1) 100%)";
                front_r.background = "radial-gradient(ellipse at center,  rgba(79, 156, 117, 1) 0%, rgba(41, 110, 75, 1) 100%)";
                front_l.opacity = 1;
                front_r.opacity = 1;

                // Inset borders for yaw in left joystick
                var el = document.createElement("div");
                back_l.appendChild(el);
                el.className += "back-limits";
            }

            joystickLeft.on('end', function(evt, data) {
                // Executes when joystick is released

                // Set values to zero
                exCharVal[output.throttle] = 0;
                exCharVal[output.yawRight] = 0;
                exCharVal[output.yawLeft] = 0;

                // Try to send data
                if(writePermission) {

                    // Setting motor values to zero
                    exWrite('reset')
                    .then(response => {
                        console.log('Quadcopter stopped: ', response)
                    })
                    .catch(response => {
                        console.log('Stopping failed: ', response);
                        console.log('Retrying...');
                        exWrite('reset');
                    });
                } else {
                    setTimeout( function() {
                        exWrite('reset');
                    }, 100);
                }
                // console.log(exCharVal);

                if(printPosition) {

                    // Debug
                    select('#debug-throttleLeft').innerHTML = '<b>Throttle</b>: 0';
                    select('#debug-yawLeft').innerHTML = '<b>Yaw</b>: 0';
                    //console.log(data);

                    reapplyLeft('.collection_0 > .front');
                }
            }).on('move', function(evt, data) {

                // Executes on every new touch event from joystick

                // Throttle is scaled from 0 - 255 to fit into one byte in Uint8Array
                var throttle = parseInt(((data.distance * Math.sin(data.angle.radian) + 75) / joystickSize) * 255);

                // Yaw is defined in pixels, with the joystick offset of 75px taken into account
                // TODO - Make joystick size and offset part of the joystick objects
                var yaw = data.distance * Math.cos(data.angle.radian) + 75;
                var yawRight = 0;
                var yawLeft = 0;

                // When yawStabilize is TRUE, a vertical zone in the middle of
                // the left joystick will result in zero yaw
                // TODO - Use variable for this zone size (20px each side for now)
                // and make it adjustable from settings menu
                if(yawStabilize) {
                    if(yaw <=  (joystickCenter - 20)) {
                        yaw = 100 * ((joystickCenter - 20 - yaw) / (joystickCenter - 20));
                        yawDir = "left";
                        yawLeft = yaw;
                    } else if(yaw >=  (joystickCenter + 20)) {
                        yaw = 100 * ((joystickCenter - 20 ) - (joystickSize - yaw)) / (joystickCenter - 20);
                        yawDir = "right";
                        yawRight = yaw;
                    } else {
                        yaw = 0;
                        yawDir = "";
                    }
                }



                // Storing and sending joystick data with the EX characteristic
                exCharVal[output.throttle] = parseInt(throttle);
                exCharVal[output.yawRight] = parseInt(yawRight);
                exCharVal[output.yawLeft] = parseInt(yawLeft);

                throttle = 100 * throttle / 255;

                // Try to send data
                if(writePermission) {
                    exWrite();
                }

                // Debug
                if(printPosition) {
                    select('#debug-throttleLeft').innerHTML = '<b>Throttle</b>: ' + throttle.toFixed(0) + '%';
                    select('#debug-yawLeft').innerHTML = '<b>Yaw</b>: ' + yaw.toFixed(0) + '% ' + yawDir;
                    //console.log(data);
                }
            })

            /** Joystick right  **/
            var joystickRight = nipplejs.create({
                zone: document.getElementById('joystick-right'),
                mode: 'static',
                position: {right: '-40px', top: '40%'},
                color: '#367d59',
                size: 150,
                restOpacity: 0.9
            });

            joystickRightPos = joystickRight.position;

            joystickRight.on('end', function(evt, data) {
                // Executes when joystick is released

                // Set values to zero
                exCharVal[output.rollRight] = 0;
                exCharVal[output.rollLeft] = 0;
                exCharVal[output.pitchForward] = 0;
                exCharVal[output.pitchBackward] = 0;

                // Try to send data
                if(writePermission) {
                    exWrite();
                }

                // console.log(exCharVal);

                if(printPosition) {
                    select('#debug-pitchRight').innerHTML = '<b>Pitch</b>: 0';
                    select('#debug-rollRight').innerHTML = '<b>Roll</b>: 0';
                    //console.log(data);
                }
            }).on('move', function(evt, data) {

                // Executes on every new touch event from joystick
                var pitch = ((data.distance * Math.sin(data.angle.radian) + 75) / joystickSize) * 100;
                var roll = ((data.distance * Math.cos(data.angle.radian) + 75) / joystickSize) * 100;
                var rollRight = 0;
                var rollLeft = 0;
                var pitchForward = 0;
                var pitchBackward = 0;

                if(roll < 50){
                    roll = maxRoll * (50 - roll) / 50;
                    rollDir = "left";
                    rollLeft = roll;
                } else if(roll > 50) {
                    roll = maxRoll * (roll - 50) / 50;
                    rollDir = "right";
                    rollRight = roll;
                }

                if(pitch < 50){
                    pitch = maxPitch * (50 - pitch) / 50;
                    pitchDir = "backward";
                    pitchBackward = pitch;
                } else if(pitch > 50) {
                    pitch = maxPitch * (pitch - 50) / 50;
                    pitchDir = "forward";
                    pitchForward = pitch;
                }

                // Storing and sending joystick data with the EX characteristic
                exCharVal[output.rollRight] = parseInt(rollRight);
                exCharVal[output.rollLeft] = parseInt(rollLeft);
                exCharVal[output.pitchForward] = parseInt(pitchForward);
                exCharVal[output.pitchBackward] = parseInt(pitchBackward);

                // Try to send data
                if(writePermission) {
                    exWrite();
                }

                //console.log(exCharVal);


                // Debug
                if(printPosition) {
                    select('#debug-pitchRight').innerHTML = '<b>Pitch</b>: ' + pitch.toFixed(0) + '&deg; '+ pitchDir;
                    select('#debug-rollRight').innerHTML = '<b>Roll</b>: ' + roll.toFixed(0)  + '&deg; ' + rollDir;
                    //console.log(data);
                }
            })

            /*  Updating PID live  */

                // Give input elements index corresponding to relevant bytes in characteristics
                var inputMap = [    'placeholder',
                                    '#roll-slave-p', '#roll-slave-i', '#roll-slave-d',
                                    '#pitch-slave-p', '#pitch-slave-i', '#pitch-slave-d',
                                    '#yaw-slave-p', '#yaw-slave-i', '#yaw-slave-d',
                                    '#roll-master-p', '#roll-master-i', '#roll-master-d',
                                    '#pitch-master-p', '#pitch-master-i', '#pitch-master-d',
                                    '#yaw-master-p', '#yaw-master-i', '#yaw-master-d'];

                /** Button actions **/

                // Send throttle and PID data to quadcopter
                addListener('#button-send', 'click', sendData);

                // Send throttle and PID data to quadcopter
                addListener('#button-reset', 'click', resetPid);

                // Send throttle and PID data to quadcopter
                addListener('#button-stop', 'click', stopQuad);


                // Function to be called on connect to set input properties
                function inputPidData() {

                    // Enable input elements
                    var inputs = document.getElementsByTagName('input');
                    for( var i = 0; i < inputs.length; i++){
                        inputs[i].disabled = false;
                    }

                    setPid(rxCharVal);
                }

                // Function for sending both PID and controller data to quadcopter
                function sendData() {

                    // Get all PID input data and store to right index of charVal
                    for(var i = 1; i <= 18; i++) {
                        txCharVal[i] = select(inputMap[i]).value;
                    }

                    // Sending PID data with txChar over BLE
                    writeArrayToChar(txChar, txCharVal)
                    .then( () => {
                        console.log("PID data sent:", txCharVal);

                        // Sending throttle data with exChar over BLE
                        /*writeArrayToChar(exChar, exCharVal)
                        .then( () => {
                            console.log("Controller data sent:", exCharVal);
                        })
                        .catch( (error) => {
                            console.log('Control data sending failed:', error)
                        });*/
                    })
                    .catch( (error) => {
                        console.log('PID data sending failed:', error)
                    });
                }

                // Reset PID values to original
                function resetPid() {
                    for(var i = 1; i <= 18; i++) {
                        select(inputMap[i]).value = originalPidData[i];
                    }
                }

                // Set PID values as passed in argument
                function setPid(val) {
                    for(var i = 1; i <= 18; i++) {
                        select(inputMap[i]).value = val[i];
                    }
                }

                function stopQuad() {
                    exCharVal[0] = 0;
                    writeArrayToChar(exChar, exCharVal)
                    .then( () => {
                        console.log("Quadcopter stopped. Data sent:", exCharVal);
                    })
                }

                // Roll and pitch parameters should always the same
                select('#roll-slave-p').addEventListener('input', function() {
                    select('#pitch-slave-p').value = this.value;
                });

                select('#roll-slave-i').addEventListener('input', function() {
                    select('#pitch-slave-i').value = this.value;
                });

                select('#roll-slave-d').addEventListener('input', function() {
                    select('#pitch-slave-d').value = this.value;
                });

                select('#pitch-slave-p').addEventListener('input', function() {
                    select('#roll-slave-p').value = this.value;
                });

                select('#pitch-slave-i').addEventListener('input', function() {
                    select('#roll-slave-i').value = this.value;
                });

                select('#pitch-slave-d').addEventListener('input', function() {
                    select('#roll-slave-d').value = this.value;
                });

                select('#roll-master-p').addEventListener('input', function() {
                    select('#pitch-master-p').value = this.value;
                });

                select('#roll-master-i').addEventListener('input', function() {
                    select('#pitch-master-i').value = this.value;
                });

                select('#roll-master-d').addEventListener('input', function() {
                    select('#pitch-master-d').value = this.value;
                });

                select('#pitch-master-p').addEventListener('input', function() {
                    select('#roll-master-p').value = this.value;
                });

                select('#pitch-master-i').addEventListener('input', function() {
                    select('#roll-master-i').value = this.value;
                });

                select('#pitch-master-d').addEventListener('input', function() {
                    select('#roll-master-d').value = this.value;
                });


            // Function to write to the EX characteristic
            function exWrite(type = 'normal') {
                if(type == 'reset')
                    exCharVal[output.throttle] = 0;

                return writeArrayToChar(exChar, exCharVal)
                .then( (p) => {
                    console.log('Sending: ', p);
                });
            }

            // END of joystick



        </script>
    </body>
</html>
