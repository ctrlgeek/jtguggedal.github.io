<!doctype html>
<html>
    <head>
        <title>Joystick testing</title>
        <meta charset="utf-8">
        <meta name="description" content="BLE quadcopter controller">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="css/joystick.css">
        <script src="js/func.js"></script>
        <script src="js/ble.js"></script>
        <script src="js/nipple.js"></script>
    </head>
    <body>
        <div id="joystick-container">
            <div id="joystick-left" class="joystick-wrapper">
            </div>
            <div id="joystick-right" class="joystick-wrapper">
            </div>
        </div>
        <div id="debug-container">
            <div id="debug-containerLeft">
                <p id="debug-throttleLeft">
                    <b>Throttle</b>: 0
                </p>
                <p id="debug-yawLeft">
                    <b>Yaw</b>: 0
                </p>
            </div>
            <div id="debug-containerRight">
                <p id="debug-pitchRight">
                    <b>Pitch</b>: 0
                </p>
                <p id="debug-rollRight">
                    <b>Roll</b>: 0
                </p>
            </div>
        </div>
        <div id="button-settings">
            <img src="img/settings.png">
        </div>
        <div id="settings-container">
            <div id="settings-inner-container">
                <h2 class="heading-menu">Settings</h2>
                <div class="settings-row">
                    <span class="settings-row-label">Maximum roll angle</span>
                    <span class="settings-row-option">60</span>
                </div>
                <div class="settings-row">
                    <span class="settings-row-label">Maximum pitch angle</span>
                    <span class="settings-row-option">60</span>
                </div>
            </div>
        </div>

        <script>

            //**
            //     Joystick, based on the amazing nippleJS by @yoannmoinet: http://yoannmoinet.github.io/nipplejs/
            //**


            // Settings for joystick
            var printPosition = 1;
            var maxRoll = 60;
            var maxPitch = 60;

            // Define byte indexes for joystick data
            var output =    {
                                throttle : 0,
                                rollRight : 1,
                                rollLeft : 2,
                                pitchForward : 3,
                                pitchBackward : 4,
                                yawRight : 5,
                                yawLeft : 6
                            };


            /** Joystick left  **/
            var joystickLeft = nipplejs.create({
                zone: select('#joystick-left'),
                mode: 'static',
                position: {left: '100px', top: '40%'},
                color: '#245582',
                size: 150,
                restOpacity: 0.95
            });
            joystickLeftPos = joystickLeft.position;

            // Function for positioning the left joystick correctly when released
            function reapplyLeft(el) {
                select(el).style.top = "75px";
            }

            joystickLeft.on('end', function(evt, data) {
                // Executes when joystick is released

                // Set values to zero
                exCharVal[output.throttle] = 0;
                exCharVal[output.yawRight] = 0;
                exCharVal[output.yawLeft] = 0;

                //console.log(exCharVal);

                if(printPosition) {

                    // Debug
                    select('#debug-throttleLeft').innerHTML = '<b>Throttle</b>: 0';
                    select('#debug-yawLeft').innerHTML = '<b>Yaw</b>: 0';
                    //console.log(data);

                    reapplyLeft('.collection_0 > .front');

                }
            }).on('move', function(evt, data) {

                // Executes on every new touch event from joystick

                var throttle = parseInt(((data.distance * Math.sin(data.angle.radian) + 75) / joystickLeft.options.size) * 100);
                var yaw = ((data.distance * Math.cos(data.angle.radian) + 75) / joystickLeft.options.size) * 100;
                var yawRight = 0;
                var yawLeft = 0;

                if(yaw < 50){
                    yaw = 100 * (50 - yaw) / 50;
                    yawDir = "left";
                    yawLeft = yaw;
                } else if(yaw > 50) {
                    yaw = 100 * (yaw - 50) / 50;
                    yawDir = "right";
                    yawRight = yaw;
                }

                // Storing and sending joystick data with the EX characteristic
                exCharVal[output.throttle] = parseInt(throttle);
                exCharVal[output.yawRight] = parseInt(yawRight);
                exCharVal[output.yawLeft] = parseInt(yawLeft);

                // Check writePermission and try to send data
                if(writePermission) {
                    writePermission = false;
                    writeArrayToChar(exChar, exCharVal)
                    .then( () => {
                        writePermission = true;
                        console.log('Sent: ', exCharVal);
                    });
                }

                // Debug
                if(printPosition) {
                    select('#debug-throttleLeft').innerHTML = '<b>Throttle</b>: ' + throttle.toFixed(0) + ' %';
                    select('#debug-yawLeft').innerHTML = '<b>Yaw</b>: ' + yaw.toFixed(0) + '% ' + yawDir;
                    //console.log(data);
                }
            })

            /** Joystick right  **/
            var joystickRight = nipplejs.create({
                zone: document.getElementById('joystick-right'),
                mode: 'static',
                position: {right: '-40px', top: '40%'},
                color: '#367d59',
                size: 150,
                restOpacity: 0.9
            });

            joystickRightPos = joystickRight.position;

            joystickRight.on('end', function(evt, data) {
                // Executes when joystick is released

                // Set values to zero
                exCharVal[output.rollRight] = 0;
                exCharVal[output.rollLeft] = 0;
                exCharVal[output.pitchForward] = 0;
                exCharVal[output.pitchBackward] = 0;

                // console.log(exCharVal);

                if(printPosition) {
                    select('#debug-pitchRight').innerHTML = '<b>Pitch</b>: 0';
                    select('#debug-rollRight').innerHTML = '<b>Roll</b>: 0';
                    //console.log(data);
                }
            }).on('move', function(evt, data) {

                // Executes on every new touch event from joystick

                var pitch = ((data.distance * Math.sin(data.angle.radian) + 75) / joystickRight.options.size) * 100;
                var roll = ((data.distance * Math.cos(data.angle.radian) + 75) / joystickRight.options.size) * 100;
                var rollRight = 0;
                var rollLeft = 0;
                var pitchForward = 0;
                var pitchBackward = 0;

                if(roll < 50){
                    roll = maxRoll * (50 - roll) / 50;
                    rollDir = "left";
                    rollLeft = roll;
                } else if(roll > 50) {
                    roll = maxRoll * (roll - 50) / 50;
                    rollDir = "right";
                    rollRight = roll;
                }

                if(pitch < 50){
                    pitch = maxPitch * (50 - pitch) / 50;
                    pitchDir = "backward";
                    pitchBackward = pitch;
                } else if(pitch > 50) {
                    pitch = maxPitch * (pitch - 50) / 50;
                    pitchDir = "forward";
                    pitchForward = pitch;
                }

                // Storing and sending joystick data with the EX characteristic
                exCharVal[output.rollRight] = parseInt(rollRight);
                exCharVal[output.rollLeft] = parseInt(rollLeft);
                exCharVal[output.pitchForward] = parseInt(pitchForward);
                exCharVal[output.pitchBackward] = parseInt(pitchBackward);

                // Check writePermission and try to send data
                if(writePermission) {
                    writePermission = false;
                    writeArrayToChar(exChar, exCharVal)
                    .then( () => {
                        writePermission = true;
                    });
                }

                //console.log(exCharVal);

                if(writePermission) {
                    writePermission = false;
                }

                // Debug
                if(printPosition) {
                    select('#debug-pitchRight').innerHTML = '<b>Pitch</b>: ' + pitch.toFixed(0) + '&deg; '+ pitchDir;
                    select('#debug-rollRight').innerHTML = '<b>Roll</b>: ' + roll.toFixed(0)  + '&deg; ' + rollDir;
                    //console.log(data);
                }
            })

            // END of joystick



        </script>
    </body>
</html>
