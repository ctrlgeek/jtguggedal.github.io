<!doctype html>
<html>
    <head>
        <title>Joystick testing</title>
        <meta charset="utf-8">
        <meta name="description" content="BLE quadcopter controller">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="css/joystick.css">
        <script src="js/func.js"></script>
        <script src="js/ble.js"></script>
        <script src="js/nipple.js"></script>
    </head>
    <body>
        <div id="joystick-container">
            <div id="joystick-left" class="joystick-wrapper">

            </div>

            <div id="joystick-right" class="joystick-wrapper">

            </div>
        </div>
        <div id="debug-container">
            <div id="debug-containerLeft">
                <p id="debug-throttleLeft">
                    <b>Throttle</b>: 0
                </p>
                <p id="debug-yawLeft">
                    <b>Yaw</b>: 0
                </p>
            </div>
            <div id="debug-containerRight">
                <p id="debug-pitchRight">
                    <b>Pitch</b>: 0
                </p>
                <p id="debug-rollRight">
                    <b>Roll</b>: 0
                </p>
            </div>
        </div>
        <script>
            var printPosition = 1;

            //**
            //     Joystick, based on the amazing nippleJS by @yoannmoinet: http://yoannmoinet.github.io/nipplejs/
            //**

            // Joystick left
            var joystickLeft = nipplejs.create({
                zone: select('#joystick-left'),
                mode: 'static',
                position: {left: '100px', top: '45%'},
                color: '#245582',
                size: 150,
                restOpacity: 0.9
            });
            joystickLeftPos = joystickLeft.position;

            // Function for positioning the left joystick correctly when released
            function reapplyLeft(el) {
                select(el).style.top = "75px";
            }

            joystickLeft.on('end', function(evt, data) {
                // Executes when joystick is released
                if(printPosition) {
                    select('#debug-throttleLeft').innerHTML = '<b>Throttle</b>: 0';
                    select('#debug-yawLeft').innerHTML = '<b>Yaw</b>: 0';
                    //console.log(data);

                    reapplyLeft('.collection_0 > .front');

                }
            }).on('move', function(evt, data) {

                // Executes on every new touch event from joystick

                var output = (data.distance / (joystickLeft.options.size / 2)) * 100;

                var throttle = ((data.distance * Math.sin(data.angle.radian) + 75) / joystickLeft.options.size) * 100;
                var yaw = ((data.distance * Math.cos(data.angle.radian) + 75) / joystickLeft.options.size) * 100;

                if(yaw < 50){
                    yaw = 100 * (50 - yaw) / 50;
                    yawDir = "left";
                } else if(yaw > 50) {
                    yaw = 100 * (yaw - 50) / 50;
                    yawDir = "right";
                }

                if(printPosition) {
                    select('#debug-throttleLeft').innerHTML = '<b>Throttle</b>: ' + throttle.toFixed(0) + ' %';
                    select('#debug-yawLeft').innerHTML = '<b>Yaw</b>: ' + yaw.toFixed(0) + '% ' + yawDir;
                    //console.log(data);
                }
            })

            // Joystick right
            var joystickRight = nipplejs.create({
                zone: document.getElementById('joystick-right'),
                mode: 'static',
                position: {right: '-40px', top: '45%'},
                color: '#367d59',
                size: 150,
                restOpacity: 0.9
            });

            joystickRightPos = joystickRight.position;

            joystickRight.on('end', function(evt, data) {
                // Executes when joystick is released
                if(printPosition) {
                    select('#debug-pitchRight').innerHTML = '<b>Pitch</b>: 0';
                    select('#debug-rollRight').innerHTML = '<b>Roll</b>: 0';
                    //console.log(data);
                }
            }).on('move', function(evt, data) {

                // Executes on every new touch event from joystick

                var pitch = ((data.distance * Math.sin(data.angle.radian) + 75) / joystickRight.options.size) * 100;
                var roll = ((data.distance * Math.cos(data.angle.radian) + 75) / joystickRight.options.size) * 100;

                if(roll < 50){
                    roll = 180 * (50 - roll) / 50;
                    rollDir = "left";
                } else if(roll > 50) {
                    roll = 180 * (roll - 50) / 50;
                    rollDir = "right";
                }


                if(pitch < 50){
                    pitch = 180 * (50 - pitch) / 50;
                    pitchDir = "backward";
                } else if(pitch > 50) {
                    pitch = 180 * (pitch - 50) / 50;
                    pitchDir = "forward";
                }


                var output = (data.distance / (joystickRight.options.size / 2)) * 100;

                if(printPosition) {
                    select('#debug-pitchRight').innerHTML = '<b>Pitch</b>: ' + pitch.toFixed(0) + '&deg; '+ pitchDir;
                    select('#debug-rollRight').innerHTML = '<b>Roll</b>: ' + roll.toFixed(0)  + '&deg; ' + rollDir;
                    //console.log(data);
                }
            })
        </script>
    </body>
</html>
