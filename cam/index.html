
<!doctype html>
<html lang="en">
    <head>

        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="https://fonts.googleapis.com/css?family=Hind:400,700" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="css/style.css">

        <title>Physical Web Car</title>
    </head>
    <body>
        <div id="wrapper">
            <div id="header-wrapper">
                <h1>Images over BLE</h1>
            </div>
            <div id="connect-wrapper">
                <div id="connect-btn">
                    Connect
                </div>
            </div>
            <div id="controllers-wrapper">
                <div class="btn-wrapper">
                    <span id="cam-single-capture-btn">Single capture</span>
                </div>
                <div class="btn-wrapper">
                    <span id="cam-start-stream-btn">Start stream</span>
                </div>
                <div class="btn-wrapper">
                    <span id="cam-stop-stream-btn">Stop stream</span>
                </div>
                <div class="btn-wrapper">
                    <span id="cam-low-res-btn">Low res.</span>
                </div>
                <div class="btn-wrapper">
                    <span id="cam-mid-res-btn">Mid. res.</span>
                </div>
                <div class="btn-wrapper">
                    <span id="cam-high-res-btn">High res.</span>
                </div>
            </div>
            <div id="img-wrapper">
                <img id="img" src="" />
            </div>
        </div>

    <script src="../common/js/ble.js"></script>
    <script src="../common/js/helper.js"></script>
    <script>

        const itsServiceAdvUUID = "6e400001-b5a3-f393-e0a9-e50e24dcca3e";
        const itsRxCharUUID = "6e400002-b5a3-f393-e0a9-e50e24dcca3e";
        const itsTxCharUUID = "6e400003-b5a3-f393-e0a9-e50e24dcca3e";
        const itsInfoCharUUID = "6e400004-b5a3-f393-e0a9-e50e24dcca3e";

        const CMD_SINGLE_CAPTURE        = 1;
        const CMD_START_STREAM          = 2;
        const CMD_STOP_STREAM           = 3;
        const CMD_CHANGE_RESOLUTION     = 4;
        const CMD_CHANGE_PHY            = 5;
        const CMD_SEND_BLE_PARAMS       = 6;

        const CMD_VAL_GAP_PHY_1MBPS     = 0;
        const CMD_VAL_GAP_PHY_2MBPS     = 1;

        const CMD_VAL_RES_160x120       = 0;
        const CMD_VAL_RES_320x240       = 1;
        const CMD_VAL_RES_640x480       = 2;
        const CMD_VAL_RES_800x600       = 3;
        const CMD_VAL_RES_1024x768      = 4;
        const CMD_VAL_RES_1600x1200     = 5;

        const CMD_INFO_IMG_SIZE         = 1;
        const CMD_INFO_BLE_PARAMS       = 2;

        var device;
        var server;
        var itsService;
        var itsRxChar;
        var itsTxChar;
        var itsInfoChar;

        var receivedImage = new Uint8Array();
        var incomingImgSize = 0;

        var isConnected = false;
        var logEnabled = true;


        function connect () {
            if (logEnabled)
                console.log("Scanning for devices with service UUID " + itsServiceAdvUUID);
            return navigator.bluetooth.requestDevice({
                    filters: [{
                        services: [itsServiceAdvUUID]
                    }]
                })
                .then(d => {
                    device = d;
                    if (logEnabled)
                        console.log("Found device " + device + ", trying to connect to GATT server");
                    return device.gatt.connect();
                })
                .then(s => {
                    server = s;
                    if (logEnabled)
                        console.log("Connected to server " + s + ", getting service");
                    return server.getPrimaryService(itsServiceAdvUUID);
                })
                .then(sc => {
                    itsService = sc;
                    if (logEnabled)
                        console.log("Found service " + itsService + ", getting characteristic");

                    return Promise.all([
                        itsService.getCharacteristic(itsRxCharUUID)
                        .then( c => { itsRxChar = c; }),
                        itsService.getCharacteristic(itsTxCharUUID)
                        .then(txNotificationsInit),
                        itsService.getCharacteristic(itsInfoCharUUID)
                        .then(infoNotificationsInit)
                    ])

                })
                .then( () => {
                    if (logEnabled)
                        console.log("Characteristics found and available globally");
                    isConnected = true;
                    onConnect();
                })
                .catch(error => {
                    console.log("Error during connect: " + error);
                });
        };

        function txNotificationsInit(characteristic) {
            'use strict';

            // Stores the notification characteristic object to ble object for global debugging access
            itsTxChar = characteristic;

            // Initiates event listener for notifications sent from DK
            itsTxChar.addEventListener('characteristicvaluechanged', txCharNotificationHandler);

            if (logEnabled)
                console.log('Notifications starting for TX characteristic');

            return itsTxChar.startNotifications();
        }


        /** Function for handling notifications **/
        function txCharNotificationHandler(event) {
            'use strict';

            // The received notification consists of a DataView object, assigned to value
            let value = event.target.value;
            value = value.buffer ? value : new DataView(value);

            var valueArray = new Uint8Array(value.byteLength);
            for(var i = 0; i < valueArray.length; i++) {
                valueArray[i] = value.getUint8(i);
            }

            receivedImage = concatTypedArrays(receivedImage, valueArray);

            if(receivedImage.length >= incomingImgSize) {
                displayImage(receivedImage);
                receivedImage = new Uint8Array([]);
                incomingImgSize = 0;
            }
        }


        function infoNotificationsInit(characteristic) {
            'use strict';

            itsInfoChar = characteristic;
            itsInfoChar.addEventListener('characteristicvaluechanged', infoCharNotificationHandler);

            if (logEnabled)
                console.log('Notifications starting for info characteristic');

            return itsInfoChar.startNotifications();
        }


        function infoCharNotificationHandler(event) {
            'use strict';

            // The received notification consists of a DataView object, assigned to value
            let value = event.target.value;
            value = value.buffer ? value : new DataView(value);

            var valueArray = new Uint8Array(value.byteLength);
            for(var i = 0; i < valueArray.length; i++) {
                valueArray[i] = value.getUint8(i);
            }
            if(valueArray[0] == CMD_INFO_IMG_SIZE) {
                incomingImgSize = u8tou32(valueArray, 1, 4);
                if (logEnabled)
                    console.log("Incoming image size: ", incomingImgSize);
            }
        }

        function sendCommand(cmd, value = 0) {
            itsRxChar.writeValue(new Uint8Array([cmd, value]));
            if(logEnabled)
                console.log("Command sent: ", cmd, value);
        }

        function displayImage(data) {
            document.getElementById('img').src = 'data:image/png;base64,' + Uint8ToBase64(data);
        }

        function u8tou32(arr, start, count) {
            var u32bytes = arr.buffer.slice(start, start + count);
            return new Uint32Array(u32bytes)[0];
        }


        function concatTypedArrays(a, b) { // a, b TypedArray of same type
            var c = new (a.constructor)(a.length + b.length);
            c.set(a, 0);
            c.set(b, a.length);
            return c;
        }

        function concatBytes(ui8a, byte) {
            var b = new Uint8Array(1);
            b[0] = byte;
            return concatTypedArrays(ui8a, b);
        }

        function bufferToBase64(buf) {
            var binstr = Array.prototype.map.call(buf, function (ch) {
                return String.fromCharCode(ch);
            }).join('');
            return btoa(binstr);
        }

        function Uint8ToBase64(u8a){
            var CHUNK_SZ = 0x8000;
            var c = [];
            for (var i=0; i < u8a.length; i+=CHUNK_SZ) {
                c.push(String.fromCharCode.apply(null, u8a.subarray(i, i+CHUNK_SZ)));
            }
            return btoa(c.join(""));
        }

        var elConnectBtn = document.querySelector('#connect-btn');

        function onConnect() {
            var h1 = document.querySelector('h1');
            elConnectBtn.style.background = "rgba(4, 113, 83, 0.8)";
            document.querySelector('#controllers-wrapper').style.display = "block";
            h1.style.fontSize = "30px";
            h1.style.marginTop = "40px"
            h1.style.marginBottom = "10px"
            elConnectBtn.style.margin = "0 auto";
            elConnectBtn.style.padding = "0 1px";
            elConnectBtn.style.width = "100px";
            elConnectBtn.style.fontSize = "14px";
            elConnectBtn.style.position = "absolute";
            elConnectBtn.style.top = "8px";
            elConnectBtn.style.right = "8px";
            elConnectBtn.innerHTML = "Connected";
        }

        clickListener("#connect-btn", connect);
        clickListener("#cam-single-capture-btn", function() { sendCommand(CMD_SINGLE_CAPTURE) });
        clickListener("#cam-start-stream-btn", function() { sendCommand(CMD_START_STREAM) });
        clickListener("#cam-stop-stream-btn", function() { sendCommand(CMD_STOP_STREAM) });
        clickListener("#cam-low-res-btn", function() { sendCommand(CMD_CHANGE_RESOLUTION, CMD_VAL_RES_160x120) });
        clickListener("#cam-mid-res-btn", function() { sendCommand(CMD_CHANGE_RESOLUTION, CMD_VAL_RES_640x480) });
        clickListener("#cam-high-res-btn", function() { sendCommand(CMD_CHANGE_RESOLUTION, CMD_VAL_RES_1600x1200) });

    </script>
    </body>
</html>
